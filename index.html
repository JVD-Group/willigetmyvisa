<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Visa Probability Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color-scheme: light;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: #f3f4f6;
            color: #111827;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .page {
            width: 100%;
            max-width: 1200px;
            padding: 16px 12px 40px;
        }

        header {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .logo {
            font-weight: 700;
            font-size: 22px;
            letter-spacing: 0.03em;
            color: #111827;
        }

        .logo span {
            color: #2563eb;
        }

        .pill {
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            color: #4b5563;
            white-space: nowrap;
        }

        .top-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 14px;
            margin-top: 4px;
        }

        .top-nav a {
            text-decoration: none;
            color: #4b5563;
            padding-bottom: 4px;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }

        .top-nav a.active {
            color: #111827;
            border-bottom-color: #2563eb;
            font-weight: 500;
        }

        @media (max-width: 640px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }
            .pill {
                width: 100%;
                text-align: left;
            }
        }

        main {
            display: grid;
            grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
            gap: 16px;
        }

        @media (max-width: 960px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
            padding: 20px 18px 18px;
        }

        h1 {
            margin: 0 0 6px;
            font-size: 24px;
            color: #111827;
        }

        h2 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #4b5563;
            font-weight: 500;
        }

        h3 {
            margin: 16px 0 8px;
            font-size: 15px;
            color: #111827;
        }

        p {
            margin: 0 0 8px;
            line-height: 1.5;
            font-size: 14px;
            color: #4b5563;
        }

        label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
            color: #111827;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 7px 8px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #111827;
            font-size: 13px;
            margin-bottom: 8px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 1px #2563eb20;
        }

        input[type="file"] {
            padding: 4px;
        }

        /* Styling for the custom searchable dropdown */
        input[list] {
             /* Resetting the default arrow often seen in select/datalist */
            appearance: none;
            -webkit-appearance: none;
        }

        .input-error {
            border-color: #dc2626 !important;
            background: #fef2f2;
        }

        .error-text {
            font-size: 11px;
            color: #b91c1c;
            margin-top: -2px;
            margin-bottom: 6px;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 640px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        .hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: -2px;
            margin-bottom: 6px;
        }

        .step-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0 14px;
            font-size: 11px;
            color: #6b7280;
        }

        .step-track {
            flex: 1;
            height: 4px;
            border-radius: 999px;
            background: #e5e7eb;
            margin-right: 10px;
            display: flex;
            overflow: hidden;
        }

        .step-segment {
            flex: 1;
            background: #e5e7eb;
            transition: background 0.15s ease-out;
        }

        .step-segment.active {
            background: linear-gradient(90deg, #22c55e, #15803d);
        }

        .step-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #6b7280;
            gap: 4px;
            margin-bottom: 4px;
        }

        .step-labels span {
            flex: 1;
            text-align: center;
            white-space: nowrap;
        }

        /* Right panel – score + voucher */

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 12px;
        }

        .score-main {
            font-size: 13px;
            color: #4b5563;
        }

        .score-main span {
            display: block;
            font-size: 26px;
            font-weight: 600;
            color: #111827;
        }

        .stage-label {
            font-size: 11px;
            color: #6b7280;
        }

        .voucher-box {
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            font-size: 12px;
            color: #4b5563;
            min-width: 200px;
        }

        .voucher-box strong {
            font-size: 18px;
            color: #15803d;
            display: block;
            margin-bottom: 4px;
        }

        .btn-voucher {
            margin-top: 4px;
            padding: 6px 10px;
            border-radius: 999px;
            border: none;
            background: #2563eb;
            color: #ffffff;
            font-size: 12px;
            cursor: pointer;
            width: 100%; /* Ensure it fits well on mobile */
        }

        .btn-voucher:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-voucher:not(:disabled):hover {
            background: #1d4ed8;
        }

        .score-bar-outer {
            width: 100%;
            height: 10px;
            border-radius: 999px;
            background: #e5e7eb;
            margin: 8px 0 4px;
            overflow: hidden;
        }

        .score-bar-inner {
            height: 100%;
            width: 0%;
            border-radius: inherit;
            background: linear-gradient(90deg, #f97316, #22c55e);
            transition: width 0.18s ease-out;
        }

        .score-caption {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .recommendations h3 {
            margin-top: 8px;
            font-size: 14px;
        }

        .recommendations ul {
            margin: 6px 0 8px 16px;
            padding: 0;
            font-size: 13px;
            color: #4b5563;
        }

        .disclaimer {
            margin-top: 10px;
            font-size: 11px;
            color: #9ca3af;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            color: #6b7280;
            margin-top: 4px;
            background: #f9fafb;
        }

        /* Travel history table */

        .table-container {
            overflow-x: auto; /* For mobile horizontal scrolling (F) */
            margin-bottom: 6px;
        }

        table {
            width: 100%;
            min-width: 600px; /* Ensure table looks reasonable on desktop and scrolls on mobile */
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th,
        td {
            border: 1px solid #e5e7eb;
            padding: 6px;
            font-size: 12px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            font-weight: 500;
            color: #4b5563;
        }

        .btn-secondary {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            background: #ffffff;
            color: #111827;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        .btn-remove-row {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #fecaca;
            background: #fef2f2;
            color: #b91c1c;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-remove-row:hover {
            background: #fee2e2;
        }
        
        .upload-section {
            border: 1px dashed #d1d5db;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fcfcfc;
        }

        /* Mobile specific stacking for right panel (F) */
        @media (max-width: 640px) {
            .score-header {
                flex-direction: column;
                align-items: stretch;
            }
            .voucher-box {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <datalist id="country-list"></datalist>
    <datalist id="currency-list"></datalist>

    <div class="page">
        <header>
            <div class="header-top">
                <div class="logo">
                    Visa Probability <span>Checker</span>
                </div>
                <div class="pill">
                    Prototype · Document-driven visa readiness & voucher concept
                </div>
            </div>
            <nav class="top-nav">
                <a href="#" aria-disabled="true">About</a>
                <a href="#" class="active" aria-current="page">Visa Success Predictor</a>
                <a href="#" aria-disabled="true">Blogs</a>
            </nav>
        </header>

        <main>
            <section class="card">
                <h1>Your trip profile</h1>
                <h2>As you add more information, your estimated visa success probability and voucher value increase.</h2>

                <div class="step-bar">
                    <div class="step-track">
                        <div class="step-segment active" id="step-start"></div>
                        <div class="step-segment" id="step-personal"></div>
                        <div class="step-segment" id="step-occupation"></div>
                        <div class="step-segment" id="step-travel"></div>
                        <div class="step-segment" id="step-visa"></div>
                    </div>
                    <span style="font-size:11px;">Journey progress</span>
                </div>
                <div class="step-labels">
                    <span>Start</span>
                    <span>Personal</span>
                    <span>Occupation</span>
                    <span>Travel history</span>
                    <span>Visa results</span>
                </div>

                <form id="visa-form" oninput="updateScoreAndProgress()">
                    <h3>1. Trip details</h3>
                    <p style="margin-bottom:6px;">Where are you travelling, when, and for how long?</p>

                    <div class="two-col">
                        <div>
                            <label for="destinationCountry">Destination country</label>
                            <input type="text" id="destinationCountry" list="country-list" placeholder="Start typing country name..." required />
                        </div>
                        <div>
                            <label for="tripPurpose">Purpose of trip</label>
                            <select id="tripPurpose" required onchange="updateScoreAndProgress()">
                                <option value="">Select purpose</option>
                                <option value="tourism">Tourism</option>
                                <option value="business">Business</option>
                                <option value="study">Study</option>
                                <option value="transit">Transit</option>
                                <option value="visit">Visiting Family/Friends</option>
                            </select>
                        </div>
                    </div>
                    <div class="two-col">
                        <div>
                            <label for="tripStart">Trip Start Date (MM/YY)</label>
                            <input type="text" id="tripStart" oninput="formatDateMMYY(this); validateTripDates()" maxlength="5" placeholder="MM/YY" required />
                            <div id="tripStartError" class="error-text" style="display:none;"></div>
                        </div>
                        <div>
                            <label for="tripEnd">Trip End Date (MM/YY)</label>
                            <input type="text" id="tripEnd" oninput="formatDateMMYY(this); validateTripDates()" maxlength="5" placeholder="MM/YY" required />
                            <div id="tripEndError" class="error-text" style="display:none;"></div>
                        </div>
                    </div>

                    <h3 id="personal-details-section">2. Personal details <span class="chip" id="personal-doc-status">Doc Required</span></h3>
                    <div class="two-col">
                        <div>
                            <label for="fullName">Full name (as per passport)</label>
                            <input type="text" id="fullName" required />
                        </div>
                        <div>
                            <label for="age">Age</label>
                            <input type="number" id="age" min="18" max="100" required />
                        </div>
                    </div>
                    <div class="two-col">
                        <div>
                            <label for="nationality">Nationality (Current Passport)</label>
                            <input type="text" id="nationality" list="country-list" placeholder="Start typing nationality..." onchange="updateScoreAndProgress();" required />
                        </div>
                        <div>
                            <label for="maritalStatus">Marital Status</label>
                            <select id="maritalStatus" required onchange="updateScoreAndProgress()">
                                <option value="">Select status</option>
                                <option value="single">Single</option>
                                <option value="married">Married</option>
                                <option value="divorced">Divorced</option>
                                <option value="widowed">Widowed</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="passportType">Type of Passport</label>
                        <select id="passportType" required onchange="updateScoreAndProgress()">
                            <option value="">Select type</option>
                            <option value="ordinary">Ordinary</option>
                            <option value="diplomatic">Diplomatic</option>
                            <option value="official">Official/Special</option>
                            <option value="service">Service</option>
                            <option value="other">Other/Refugee</option>
                        </select>
                    </div>

                    <div class="upload-section">
                        <label>Passport Upload (Mandatory for Voucher)</label>
                        <p class="hint">Upload clear scans/photos of your passport's photo page and back cover. (Max 5MB)</p>
                        <input type="file" id="passportUpload" accept="image/*, application/pdf" onchange="checkDocumentStatus('personal')" multiple>
                    </div>


                    <h3 id="occupation-section">3. Occupation & income <span class="chip" id="occupation-doc-status">Optional Docs</span></h3>
                    <div class="two-col">
                        <div>
                            <label for="occupationStatus">Employment Status</label>
                            <select id="occupationStatus" required onchange="updateScoreAndProgress()">
                                <option value="">Select status</option>
                                <option value="employed">Employed</option>
                                <option value="self-employed">Self-employed</option>
                                <option value="student">Student</option>
                                <option value="unemployed">Unemployed</option>
                                <option value="retired">Retired</option>
                            </select>
                        </div>
                        <div>
                            <label for="annualIncome">Annual Gross Income</label>
                            <input type="number" id="annualIncome" min="0" required />
                        </div>
                    </div>
                    <div>
                        <label for="incomeCurrency">Income Currency</label>
                        <input type="text" id="incomeCurrency" list="currency-list" placeholder="Start typing currency name..." required />
                    </div>


                    <h3 id="travel-history-section">4. Travel history <span class="chip" id="travel-doc-status">Doc Required</span></h3>
                    <p class="hint">List all trips abroad in the last 10 years, including destination country, and start/end dates.</p>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Country</th>
                                    <th>Start Date (MM/YY)</th>
                                    <th>End Date (MM/YY)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="travelHistoryTableBody">
                                <tr data-removable="false">
                                    <td><input type="text" class="travel-country" list="country-list" placeholder="Country" required /></td>
                                    <td><input type="text" class="travel-start-date" oninput="formatDateMMYY(this); validateTravelHistoryDates()" maxlength="5" placeholder="MM/YY" required></td>
                                    <td><input type="text" class="travel-end-date" oninput="formatDateMMYY(this); validateTravelHistoryDates()" maxlength="5" placeholder="MM/YY" required></td>
                                    <td><button type="button" class="btn-remove-row" disabled>Initial</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="button" class="btn-secondary" onclick="addTravelRow()">+ Add another trip</button>

                    <div class="upload-section">
                        <label>Passport Stamps/Boarding Passes (Mandatory for Voucher)</label>
                        <p class="hint">Upload files showing your previous travel stamps or boarding passes. (Max 5MB, JPG, PNG, PDF)</p>
                        <input type="file" id="travelDocUpload" accept="image/*, application/pdf" onchange="checkDocumentStatus('travel')" multiple>
                    </div>
                    <div id="travelHistoryError" class="error-text" style="display:none;"></div>

                    <h3 id="visa-outcome-section">5. Previous visa outcomes <span class="chip" id="visa-doc-status">Doc Required</span></h3>
                    <p class="hint">Have you been approved or rejected for a visa in the last 5 years?</p>

                    <div style="margin-bottom: 12px;">
                        <label>Did you receive a visa?</label>
                        <label style="display:inline-block; margin-right: 15px;">
                            <input type="radio" name="visaOutcome" value="yes" required onchange="updateScoreAndProgress()"> Yes
                        </label>
                        <label style="display:inline-block;">
                            <input type="radio" name="visaOutcome" value="no" onchange="updateScoreAndProgress()"> No
                        </label>
                    </div>

                    <div class="upload-section">
                        <label>Visa Approval/Rejection Letter (Mandatory for Voucher)</label>
                        <p class="hint">Upload the official outcome letter (approval or rejection) from the embassy/consulate. (Max 5MB, JPG, PNG, PDF)</p>
                        <input type="file" id="visaDocUpload" accept="image/*, application/pdf" onchange="checkDocumentStatus('visa')" multiple>
                    </div>
                </form>

            </section>

            <section class="card">
                <div class="score-header">
                    <div class="score-main">
                        Estimated Success Probability
                        <span id="score-percentage">0%</span>
                    </div>
                    <div class="voucher-box">
                        Potential Voucher Value
                        <strong id="voucher-value">₹0</strong>
                        <p class="stage-label">Unlocked on next document upload</p>
                        <button class="btn-voucher" id="voucherButtonPersonal" data-stage="personal" disabled>
                            Generate ₹10 Voucher (Need Passport Upload)
                        </button>
                        <button class="btn-voucher" id="voucherButtonOccupation" data-stage="occupation" disabled style="display:none;">
                            Generate ₹50 Voucher (Stage Complete)
                        </button>
                        <button class="btn-voucher" id="voucherButtonTravel" data-stage="travel" disabled style="display:none;">
                            Generate ₹200 Voucher (Need Stamps Upload)
                        </button>
                        <button class="btn-voucher" id="voucherButtonVisa" data-stage="visa" disabled style="display:none;">
                            Generate ₹1000 Voucher (Need Letter Upload)
                        </button>
                    </div>
                </div>

                <div class="score-bar-outer">
                    <div class="score-bar-inner" style="width: 0%;"></div>
                </div>
                <div class="score-caption">
                    Probability is simulated based on your entered profile strength.
                </div>

                <div class="recommendations">
                    <h3>Profile Recommendations</h3>
                    <ul id="recommendation-list">
                        <li>Start by completing the **Trip Details** section.</li>
                    </ul>
                </div>

                <p class="disclaimer">
                    This tool provides an estimated probability based on submitted data and should not be used as official advice.
                </p>
            </section>
        </main>
    </div>

    <script>
        // --- 1. PROTOTYPE DATA AND CONSTANTS ---

        // Full country list (4, 7)
        const FULL_COUNTRIES = [
            "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria",
            "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan",
            "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia",
            "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Congo-Brazzaville)", "Costa Rica",
            "Croatia", "Cuba", "Cyprus", "Czechia (Czech Republic)", "Democratic Republic of the Congo", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador",
            "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini (fmr. Swaziland)", "Ethiopia", "Fiji", "Finland", "France",
            "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau",
            "Guyana", "Haiti", "Holy See", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq",
            "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kuwait",
            "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
            "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico",
            "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar (formerly Burma)", "Namibia", "Nauru",
            "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia (formerly Macedonia)", "Norway", "Oman",
            "Pakistan", "Palau", "Palestine State", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
            "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe",
            "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
            "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
            "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan",
            "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States of America", "Uruguay", "Uzbekistan", "Vanuatu", "Venezuela",
            "Vietnam", "Yemen", "Zambia", "Zimbabwe"
        ];
        
        // Full currency list (6)
        const FULL_CURRENCIES = [
            "USD - United States Dollar", "EUR - Euro", "JPY - Japanese Yen", "GBP - British Pound Sterling", "AUD - Australian Dollar",
            "CAD - Canadian Dollar", "CHF - Swiss Franc", "CNY - Chinese Yuan", "SEK - Swedish Krona", "NZD - New Zealand Dollar",
            "MXN - Mexican Peso", "SGD - Singapore Dollar", "HKD - Hong Kong Dollar", "NOK - Norwegian Krone", "KRW - South Korean Won",
            "TRY - Turkish Lira", "RUB - Russian Ruble", "INR - Indian Rupee", "BRL - Brazilian Real", "ZAR - South African Rand",
            "PHP - Philippine Peso", "CZK - Czech Koruna", "PLN - Polish Złoty", "HUF - Hungarian Forint", "ILS - Israeli New Shekel",
            "CLP - Chilean Peso", "AED - UAE Dirham", "SAR - Saudi Riyal", "DKK - Danish Krone", "MYR - Malaysian Ringgit",
            "THB - Thai Baht", "IDR - Indonesian Rupiah", "PKR - Pakistani Rupee", "EGP - Egyptian Pound", "QAR - Qatari Riyal",
            "VND - Vietnamese Đồng", "COP - Colombian Peso", "NGN - Nigerian Naira", "ARS - Argentine Peso", "Other Currency"
        ];

        const STAGES = {
            start: { score: 0, voucher: 0, button: null, requiredDoc: null, docStatus: false, isComplete: true, label: "Start" },
            personal: { score: 20, voucher: 10, button: 'voucherButtonPersonal', requiredDoc: 'passportUpload', docStatus: false, isComplete: false, label: "Personal Details" },
            occupation: { score: 40, voucher: 50, button: 'voucherButtonOccupation', requiredDoc: null, docStatus: false, isComplete: false, label: "Occupation & Income" },
            travel: { score: 70, voucher: 200, button: 'voucherButtonTravel', requiredDoc: 'travelDocUpload', docStatus: false, isComplete: false, label: "Travel History" },
            visa: { score: 90, voucher: 1000, button: 'voucherButtonVisa', requiredDoc: 'visaDocUpload', docStatus: false, isComplete: false, label: "Visa Outcomes" },
        };

        // --- 2. INITIALIZATION FUNCTIONS ---

        function populateDropdowns() {
            // 4, 6. Populate Datalists for Searchable Fields
            const countryDatalist = document.getElementById('country-list');
            const currencyDatalist = document.getElementById('currency-list');

            // Populate Countries
            FULL_COUNTRIES.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                countryDatalist.appendChild(option);
            });

            // Populate Currencies
            FULL_CURRENCIES.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                currencyDatalist.appendChild(option);
            });
        }

        // --- 3. MM/YY FORMATTING AND PARSING (1, 2) ---

        /**
         * 1, 2. Auto-formats input to MM/YY similar to a credit card expiry date.
         */
        function formatDateMMYY(input) {
            let value = input.value.replace(/\D/g, ''); // Remove all non-digits
            
            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            
            if (value.length > 5) {
                value = value.substring(0, 5);
            }

            // Cap month at 12
            if (value.length === 2 && parseInt(value) > 12) {
                value = '12';
            }
            
            input.value = value;
        }

        /**
         * Parses MM/YY string into a Date object (approx. 1st of the month).
         */
        function parseMMYY(dateString) {
            const parts = dateString.split('/');
            if (parts.length === 2 && parts[0].length === 2 && parts[1].length === 2) {
                const month = parseInt(parts[0], 10);
                const year = parseInt(parts[1], 10) + 2000; // Assume 21st century (e.g., 25 -> 2025)

                if (month >= 1 && month <= 12) {
                    return new Date(year, month - 1, 1); // Month is 0-indexed in JS Date
                }
            }
            return null;
        }

        // --- 4. DYNAMIC ELEMENTS & VOUCHER LOGIC ---

        function getVoucherCurrencySymbol() {
            // 5. Currency logic based on Nationality (using Nationality as a client-side proxy for location)
            const nationalityInput = document.getElementById('nationality').value;
            if (nationalityInput.includes('India')) return '₹';
            if (nationalityInput.includes('Emirates')) return 'AED';
            return '$'; // Default
        }

        function updateVoucherButtons() {
            const currencySymbol = getVoucherCurrencySymbol();
            let lastUnlockedStage = 'start';

            for (const stageKey in STAGES) {
                const stage = STAGES[stageKey];
                const button = stage.button ? document.getElementById(stage.button) : null;
                if (button) {
                    button.style.display = 'none';
                }

                if (stage.isComplete) {
                    lastUnlockedStage = stageKey;
                }
            }

            const stagesOrder = Object.keys(STAGES);
            let nextStageKey = null;
            let currentVoucherValue = 0;

            for (let i = 0; i < stagesOrder.length; i++) {
                const key = stagesOrder[i];
                if (STAGES[key].isComplete) {
                    currentVoucherValue = STAGES[key].voucher;
                    
                    if (i + 1 < stagesOrder.length) {
                        nextStageKey = stagesOrder[i + 1];
                    }
                }
            }
            
            const nextStage = STAGES[nextStageKey] || null;

            // Update main voucher display (5)
            document.getElementById('voucher-value').innerHTML = `${currencySymbol}${currentVoucherValue}`;

            // Handle the button display and enablement
            if (nextStage) {
                const nextButton = document.getElementById(nextStage.button);
                const nextDocRequired = nextStage.requiredDoc;
                
                if (nextButton) {
                    nextButton.style.display = 'block';
                    nextButton.innerHTML = `Generate ${currencySymbol}${nextStage.voucher} Voucher`;

                    // Gating by document status
                    if (nextDocRequired && !nextStage.docStatus) {
                        nextButton.disabled = true;
                        nextButton.innerHTML += ` (Need Document Upload)`;
                        document.querySelector('.stage-label').textContent = `Unlocked upon document upload for ${nextStage.label}.`;
                    } else {
                        nextButton.disabled = false;
                        document.querySelector('.stage-label').textContent = `Document requirements met. Click to claim voucher.`;
                    }
                } else {
                    document.querySelector('.stage-label').textContent = `Stage complete.`;
                }

            } else {
                // All stages complete
                document.querySelector('.stage-label').textContent = `All stages complete! Max voucher value achieved.`;
            }
        }

        function checkDocumentStatus(stageKey) {
            const stage = STAGES[stageKey];
            if (!stage || !stage.requiredDoc) return;

            const fileInput = document.getElementById(stage.requiredDoc);
            
            stage.docStatus = (fileInput && fileInput.files.length > 0);

            const docChip = document.getElementById(`${stageKey}-doc-status`);
            if (docChip) {
                 docChip.textContent = stage.docStatus ? 'Doc Uploaded' : 'Doc Required';
                 docChip.style.borderColor = stage.docStatus ? '#10b981' : '#d1d5db';
                 docChip.style.color = stage.docStatus ? '#059669' : '#6b7280';
            }

            updateScoreAndProgress();
        }

        // --- 5. FORM AND VALIDATION LOGIC (1) ---

        function validateTripDates() {
            const startInput = document.getElementById('tripStart');
            const endInput = document.getElementById('tripEnd');
            const startError = document.getElementById('tripStartError');
            const endError = document.getElementById('tripEndError');
            
            const startDate = parseMMYY(startInput.value);
            const endDate = parseMMYY(endInput.value);
            const today = new Date();
            let isValid = true;
            
            startInput.classList.remove('input-error');
            startError.style.display = 'none';
            endInput.classList.remove('input-error');
            endError.style.display = 'none';

            // Check if MM/YY format is complete
            if (startInput.value.length !== 5 || !startDate) {
                if (startInput.value.length === 5) {
                    startInput.classList.add('input-error');
                    startError.textContent = 'Invalid MM/YY date.';
                    startError.style.display = 'block';
                    isValid = false;
                }
            }

            // C. Trip Dates: Cannot be in the past (must be in the future or current month)
            if (startDate && startDate < new Date(today.getFullYear(), today.getMonth(), 1)) {
                startInput.classList.add('input-error');
                startError.textContent = 'Trip must be in the current or future month.';
                startError.style.display = 'block';
                isValid = false;
            } 

            // C. Trip Dates: Start <= End
            if (startDate && endDate && startDate > endDate) {
                endInput.classList.add('input-error');
                endError.textContent = 'End date cannot be before start date.';
                endError.style.display = 'block';
                isValid = false;
            }

            updateScoreAndProgress();
            return isValid;
        }
        
        // --- 6. FORM AND VALIDATION LOGIC (2) ---

        function validateTravelHistoryDates() {
            const travelRows = document.querySelectorAll('#travelHistoryTableBody tr');
            const travelHistoryError = document.getElementById('travelHistoryError');
            let hasError = false;
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            travelRows.forEach(row => {
                const startInput = row.querySelector('.travel-start-date');
                const endInput = row.querySelector('.travel-end-date');
                const startDate = parseMMYY(startInput.value);
                const endDate = parseMMYY(endInput.value);

                startInput.classList.remove('input-error');
                endInput.classList.remove('input-error');

                // Check if MM/YY format is complete
                if (startInput.value.length !== 5 || !startDate) {
                    if (startInput.value.length === 5) hasError = true;
                }
                if (endInput.value.length !== 5 || !endDate) {
                    if (endInput.value.length === 5) hasError = true;
                }

                // C. Travel History Dates: Cannot be in the future (must be past month or current month)
                if (startDate && startDate > currentMonthStart) {
                    startInput.classList.add('input-error');
                    hasError = true;
                }

                // C. Travel History Dates: Start <= End
                if (startDate && endDate && startDate > endDate) {
                    endInput.classList.add('input-error');
                    hasError = true;
                }
            });

            if (hasError) {
                travelHistoryError.textContent = 'History dates must be in the past (MM/YY) and start before the end date.';
                travelHistoryError.style.display = 'block';
            } else {
                travelHistoryError.style.display = 'none';
            }

            updateScoreAndProgress();
            return !hasError;
        }

        function checkStageCompletion() {
            const form = document.getElementById('visa-form');
            const data = new FormData(form);
            let totalComplete = 0;

            // Helper to check if a datalist input has a value
            const checkDatalistValue = (id) => document.getElementById(id).value.trim() !== '';

            // 1. Trip details (Must be filled)
            const tripDatesValid = validateTripDates();
            STAGES.start.isComplete = checkDatalistValue('destinationCountry') && data.get('tripPurpose') && tripDatesValid;
            if (STAGES.start.isComplete) totalComplete = 1;

            // 2. Personal Details (Must be filled - 7 new field included)
            STAGES.personal.isComplete = STAGES.start.isComplete && data.get('fullName') && data.get('age') && checkDatalistValue('nationality') && data.get('maritalStatus') && data.get('passportType');
            if (STAGES.personal.isComplete) totalComplete = 2;

            // 3. Occupation & Income (Must be filled)
            STAGES.occupation.isComplete = STAGES.personal.isComplete && data.get('occupationStatus') && data.get('annualIncome') && checkDatalistValue('incomeCurrency');
            if (STAGES.occupation.isComplete) totalComplete = 3;

            // 4. Travel History (Must have 1 valid row)
            const travelRows = document.querySelectorAll('#travelHistoryTableBody tr');
            let hasTravelHistory = false;
            const historyDatesValid = validateTravelHistoryDates();

            if (travelRows.length > 0 && historyDatesValid) {
                travelRows.forEach(row => {
                    const country = row.querySelector('.travel-country').value;
                    const start = row.querySelector('.travel-start-date').value;
                    const end = row.querySelector('.travel-end-date').value;
                    if (country && start.length === 5 && end.length === 5) {
                        hasTravelHistory = true;
                    }
                });
            }
            STAGES.travel.isComplete = STAGES.occupation.isComplete && hasTravelHistory;
            if (STAGES.travel.isComplete) totalComplete = 4;

            // 5. Visa Outcomes (Must be answered)
            STAGES.visa.isComplete = STAGES.travel.isComplete && data.get('visaOutcome') !== null;
            if (STAGES.visa.isComplete) totalComplete = 5;
            
            return totalComplete;
        }

        function updateScoreAndProgress() {
            const stagesOrder = Object.keys(STAGES);
            const totalCompleteCount = checkStageCompletion();
            let currentMaxScore = 0;
            let currentVoucherValue = 0;
            const recommendations = [];

            // Update progress bar & score
            for (let i = 0; i < stagesOrder.length; i++) {
                const key = stagesOrder[i];
                const stage = STAGES[key];
                const segment = document.getElementById(`step-${key}`);
                
                if (i < totalCompleteCount) {
                    segment.classList.add('active');
                    currentMaxScore = stage.score;
                    currentVoucherValue = stage.voucher;
                } else {
                    segment.classList.remove('active');
                }
            }

            document.getElementById('score-percentage').textContent = `${currentMaxScore}%`;
            document.querySelector('.score-bar-inner').style.width = `${currentMaxScore}%`;

            // Update Recommendations (simplified for brevity)
            const recs = [
                { stage: 'start', check: STAGES.start.isComplete, text: "Complete **Trip Details** to begin score calculation." },
                { stage: 'personal', check: STAGES.personal.isComplete, text: "Fill out **Personal Details** to reach 20%." },
                { stage: 'personal_doc', check: STAGES.personal.isComplete && STAGES.personal.docStatus, text: "Upload **Passport** to unlock the first voucher." },
                { stage: 'occupation', check: STAGES.occupation.isComplete, text: "Fill out **Occupation & Income** to reach 40%." },
                { stage: 'travel', check: STAGES.travel.isComplete, text: "Add **Travel History** entries to reach 70%." },
                { stage: 'travel_doc', check: STAGES.travel.isComplete && STAGES.travel.docStatus, text: "Upload **Passport Stamps/Boarding Passes** for the ₹200 voucher." },
                { stage: 'visa', check: STAGES.visa.isComplete, text: "Complete **Visa Outcome** section to reach 90%." },
                { stage: 'visa_doc', check: STAGES.visa.isComplete && STAGES.visa.docStatus, text: "Upload **Visa Outcome Letter** for the final ₹1000 voucher." },
            ];
            
            let completedAll = true;
            for (const rec of recs) {
                if (!rec.check) {
                    recommendations.push(rec.text);
                    completedAll = false;
                    // Stop at the first unfulfilled requirement (or document step)
                    break;
                }
            }

            if (completedAll) {
                recommendations.push("Profile is highly detailed. You have reached max potential score.");
            }
            
            const recList = document.getElementById('recommendation-list');
            recList.innerHTML = '';
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.innerHTML = rec.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); // Simple markdown for bold
                recList.appendChild(li);
            });

            // Update Voucher Buttons (B, D)
            updateVoucherButtons();
        }

        function addTravelRow() {
            const travelHistoryTableBody = document.getElementById('travelHistoryTableBody');
            const newRow = travelHistoryTableBody.insertRow();
            
            newRow.innerHTML = `
                <td><input type="text" class="travel-country" list="country-list" placeholder="Country" required /></td>
                <td><input type="text" class="travel-start-date" oninput="formatDateMMYY(this); validateTravelHistoryDates()" maxlength="5" placeholder="MM/YY" required></td>
                <td><input type="text" class="travel-end-date" oninput="formatDateMMYY(this); validateTravelHistoryDates()" maxlength="5" placeholder="MM/YY" required></td>
                <td><button type="button" class="btn-remove-row" onclick="removeTravelRow(this)">Remove</button></td>
            `;

            updateScoreAndProgress();
        }

        function removeTravelRow(button) {
            const row = button.parentNode.parentNode;
            const travelHistoryTableBody = document.getElementById('travelHistoryTableBody');

            if (row.dataset.removable === 'false') {
                return; // Prevent removal of the first row
            }
            
            if (travelHistoryTableBody.rows.length > 1) {
                row.remove();
                updateScoreAndProgress();
            }
        }

        // --- 7. INITIAL EXECUTION ---
        document.addEventListener('DOMContentLoaded', () => {
            populateDropdowns();
            updateScoreAndProgress(); 

            // Initialize the first row's remove button state (disabled)
            const firstRowButton = document.querySelector('#travelHistoryTableBody tr[data-removable="false"] .btn-remove-row');
            if(firstRowButton) {
                firstRowButton.disabled = true;
                firstRowButton.textContent = 'Initial';
            }
            
            document.getElementById('passportUpload').addEventListener('change', () => checkDocumentStatus('personal'));
            document.getElementById('travelDocUpload').addEventListener('change', () => checkDocumentStatus('travel'));
            document.getElementById('visaDocUpload').addEventListener('change', () => checkDocumentStatus('visa'));
        });

    </script>
</body>
</html>